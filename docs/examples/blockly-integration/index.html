<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Universal Agents Blockly Integration</title>
  <!-- Load Blockly libraries -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
  <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
  <script src="https://unpkg.com/blockly/python_compressed.js"></script>
  <script src="https://unpkg.com/blockly/msg/en.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    .header {
      background-color: #333;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .title {
      font-size: 1.5em;
      margin: 0;
    }
    
    .controls {
      display: flex;
      gap: 10px;
    }
    
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .blockly-container {
      flex: 2;
      height: 100%;
      position: relative;
    }
    
    #blocklyDiv {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    .code-container {
      flex: 1;
      background-color: #f5f5f5;
      padding: 10px;
      overflow: auto;
      display: flex;
      flex-direction: column;
    }
    
    .code-tabs {
      display: flex;
      margin-bottom: 10px;
    }
    
    .code-tab {
      padding: 8px 16px;
      background-color: #ddd;
      border: none;
      cursor: pointer;
    }
    
    .code-tab.active {
      background-color: #fff;
    }
    
    .code-panel {
      display: none;
      flex: 1;
      overflow: auto;
    }
    
    .code-panel.active {
      display: block;
    }
    
    .code {
      font-family: monospace;
      white-space: pre;
      background-color: white;
      padding: 10px;
      border: 1px solid #ddd;
      height: 100%;
      overflow: auto;
    }
    
    .footer {
      background-color: #f0f0f0;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #ddd;
    }
    
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    .secondary-button {
      background-color: #2196F3;
    }
    
    .secondary-button:hover {
      background-color: #0b7dda;
    }
    
    .danger-button {
      background-color: #f44336;
    }
    
    .danger-button:hover {
      background-color: #da190b;
    }
    
    .status {
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="title">Universal Agents Blockly Integration</h1>
    <div class="controls">
      <button id="saveButton" class="secondary-button">Save</button>
      <button id="loadButton" class="secondary-button">Load</button>
      <button id="exportButton" class="secondary-button">Export Code</button>
      <button id="runButton">Run Flow</button>
      <button id="testButton" style="background-color: #9c27b0;">Run Tests</button>
    </div>
  </div>
  
  <div class="main-container">
    <div class="blockly-container">
      <div id="blocklyDiv"></div>
    </div>
    
    <div class="code-container">
      <div class="code-tabs">
        <button class="code-tab active" id="jsTab">JavaScript</button>
        <button class="code-tab" id="pythonTab">Python</button>
        <button class="code-tab" id="flowTab">Flow Visualization</button>
      </div>
      
      <div id="jsPanel" class="code-panel active">
        <div id="codeDiv" class="code">// JavaScript code will appear here</div>
      </div>
      
      <div id="pythonPanel" class="code-panel">
        <div id="pythonCodeDiv" class="code"># Python code will appear here</div>
      </div>
      
      <div id="flowPanel" class="code-panel">
        <div id="flowVisualization" class="code">
          Flow visualization will appear here when you run the flow.
        </div>
      </div>
    </div>
  </div>
  
  <div class="footer">
    <div class="status" id="statusBar">Ready</div>
    <div>
      <button id="clearButton" class="danger-button">Clear Workspace</button>
    </div>
  </div>

  <xml id="toolbox" style="display: none">
    <category name="Core" colour="#5C81A6">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="controls_repeat_ext"></block>
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="text"></block>
      <block type="text_print"></block>
    </category>
    <category name="Universal Agents" colour="#A65C94">
      <block type="universal_agents_node"></block>
      <block type="universal_agents_flow"></block>
      <block type="universal_model_node"></block>
    </category>
    <category name="Patterns" colour="#5CA694">
      <block type="text_print">
        <field name="TEXT">RAG Pattern (Placeholder)</field>
      </block>
      <block type="text_print">
        <field name="TEXT">Map-Reduce Pattern (Placeholder)</field>
      </block>
    </category>
  </xml>
  
  <!-- Load block definitions -->
  <script src="basic_node_block_definition.js"></script>
  <script src="flow_block_definition.js"></script>
  <script src="model_node_block_definition.js"></script>
  <script src="toolbox_configuration.js"></script>
  
  <!-- The below workspace initialization will be handled by toolbox_configuration.js -->
  <script>
    /* Workspace injection is now handled in toolbox_configuration.js
    var workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      grid: {
        spacing: 20,
        length: 3,
        colour: '#ccc',
        snap: true
      },
      zoom: {
        controls: true,
        wheel: true,
        startScale: 1.0,
        maxScale: 3,
        minScale: 0.3,
        scaleSpeed: 1.2
      },
      trashcan: true
    });
    */
    
    // Get the main workspace that was created by toolbox_configuration.js
    var workspace = Blockly.getMainWorkspace();

    // Function to update JavaScript code
    function updateJSCode() {
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      document.getElementById('codeDiv').textContent = code || '// JavaScript code will appear here';
    }

    // Function to update Python code
    function updatePyCode() {
      var code = Blockly.Python.workspaceToCode(workspace);
      document.getElementById('pythonCodeDiv').textContent = code || '# Python code will appear here';
    }

    // Update code when blocks change
    workspace.addChangeListener(function(event) {
      if (event.type != Blockly.Events.UI) {
        updateJSCode();
        updatePyCode();
      }
    });

    // Tab switching
    document.getElementById('jsTab').addEventListener('click', function() {
      document.querySelectorAll('.code-panel').forEach(function(panel) {
        panel.classList.remove('active');
      });
      document.querySelectorAll('.code-tab').forEach(function(tab) {
        tab.classList.remove('active');
      });
      document.getElementById('jsPanel').classList.add('active');
      this.classList.add('active');
    });

    document.getElementById('pythonTab').addEventListener('click', function() {
      document.querySelectorAll('.code-panel').forEach(function(panel) {
        panel.classList.remove('active');
      });
      document.querySelectorAll('.code-tab').forEach(function(tab) {
        tab.classList.remove('active');
      });
      document.getElementById('pythonPanel').classList.add('active');
      this.classList.add('active');
    });

    document.getElementById('flowTab').addEventListener('click', function() {
      document.querySelectorAll('.code-panel').forEach(function(panel) {
        panel.classList.remove('active');
      });
      document.querySelectorAll('.code-tab').forEach(function(tab) {
        tab.classList.remove('active');
      });
      document.getElementById('flowPanel').classList.add('active');
      this.classList.add('active');
    });

    // Save and load functions
    document.getElementById('saveButton').addEventListener('click', function() {
      var xml = Blockly.Xml.workspaceToDom(workspace);
      var xmlText = Blockly.Xml.domToText(xml);
      localStorage.setItem('universalAgentsBlocks', xmlText);
      document.getElementById('statusBar').textContent = 'Workspace saved to local storage';
    });

    document.getElementById('loadButton').addEventListener('click', function() {
      var xmlText = localStorage.getItem('universalAgentsBlocks');
      if (xmlText) {
        workspace.clear();
        var xml = Blockly.Xml.textToDom(xmlText);
        Blockly.Xml.domToWorkspace(xml, workspace);
        document.getElementById('statusBar').textContent = 'Workspace loaded from local storage';
      } else {
        document.getElementById('statusBar').textContent = 'No saved workspace found in local storage';
      }
    });

    // Run button
    document.getElementById('runButton').addEventListener('click', function() {
      // Simulate running the flow
      var blocks = workspace.getAllBlocks(false);
      document.getElementById('statusBar').textContent = 'Running flow with ' + blocks.length + ' blocks';
      
      // Simple visualization
      document.getElementById('flowVisualization').innerHTML = 
        'Flow execution started with ' + blocks.length + ' blocks.<br>' +
        'Execution path: ' + blocks.map(function(block) {
          return block.type;
        }).join(' â†’ ');
      
      // Highlight blocks in sequence
      highlightBlocks(blocks);
    });

    // Highlight blocks one by one
    function highlightBlocks(blocks) {
      var i = 0;
      function highlightNext() {
        // Reset all blocks
        blocks.forEach(function(block) {
          block.setHighlighted(false);
        });
        
        if (i < blocks.length) {
          blocks[i].setHighlighted(true);
          i++;
          setTimeout(highlightNext, 500);
        }
      }
      highlightNext();
    }

    // Clear workspace
    document.getElementById('clearButton').addEventListener('click', function() {
      if (confirm('Are you sure you want to clear the workspace?')) {
        workspace.clear();
        updateJSCode();
        updatePyCode();
        document.getElementById('statusBar').textContent = 'Workspace cleared';
      }
    });

    // Export code
    document.getElementById('exportButton').addEventListener('click', function() {
      var code, filename;
      
      if (document.getElementById('jsPanel').classList.contains('active')) {
        code = document.getElementById('codeDiv').textContent;
        filename = 'universal_agents_flow.js';
      } else if (document.getElementById('pythonPanel').classList.contains('active')) {
        code = document.getElementById('pythonCodeDiv').textContent;
        filename = 'universal_agents_flow.py';
      } else {
        return;
      }
      
      var blob = new Blob([code], {type: 'text/plain'});
      var a = document.createElement('a');
      a.download = filename;
      a.href = URL.createObjectURL(blob);
      a.click();
      
      document.getElementById('statusBar').textContent = 'Code exported as ' + filename;
    });

    // Initialize
    updateJSCode();
    updatePyCode();
  </script>
  
  <!-- Load test script -->
  <script src="test.js"></script>
  
  <script>
    // Browser compatibility check
    function checkBrowserCompatibility() {
      const isChrome = /Chrome/.test(navigator.userAgent) && !/Edg/.test(navigator.userAgent);
      const isFirefox = /Firefox/.test(navigator.userAgent);
      const isEdge = /Edg/.test(navigator.userAgent);
      
      if (!isChrome && !isFirefox && !isEdge) {
        console.warn('You are using a browser that may not be fully compatible with this demo.');
        console.warn('For best results, please use Chrome, Firefox, or Edge.');
        
        // Show warning message
        const warning = document.createElement('div');
        warning.style.position = 'fixed';
        warning.style.top = '0';
        warning.style.left = '0';
        warning.style.right = '0';
        warning.style.backgroundColor = '#fff3cd';
        warning.style.borderBottom = '1px solid #ffeeba';
        warning.style.color = '#856404';
        warning.style.padding = '10px';
        warning.style.textAlign = 'center';
        warning.style.zIndex = '2000';
        warning.innerHTML = '<strong>Warning:</strong> You are using a browser that may not be fully compatible with this demo. For best results, please use Chrome, Firefox, or Edge. <button id="dismissWarning" style="margin-left: 10px; border: 1px solid #856404; background-color: transparent; padding: 3px 10px; cursor: pointer;">Dismiss</button>';
        
        document.body.appendChild(warning);
        
        // Add dismiss button handler
        document.getElementById('dismissWarning').addEventListener('click', function() {
          document.body.removeChild(warning);
        });
      }
    }
    
    // Check Blockly loading
    function checkBlocklyLoaded() {
      if (typeof Blockly === 'undefined') {
        console.error('Blockly is not loaded. This may be due to network issues or content blocking.');
        
        // Show error message
        const error = document.createElement('div');
        error.style.position = 'fixed';
        error.style.top = '50%';
        error.style.left = '50%';
        error.style.transform = 'translate(-50%, -50%)';
        error.style.backgroundColor = '#f8d7da';
        error.style.border = '1px solid #f5c6cb';
        error.style.borderRadius = '5px';
        error.style.color = '#721c24';
        error.style.padding = '20px';
        error.style.textAlign = 'center';
        error.style.zIndex = '2000';
        error.style.width = '80%';
        error.style.maxWidth = '500px';
        error.innerHTML = `
          <h3>Error: Blockly Not Loaded</h3>
          <p>The Blockly library could not be loaded. This may be due to:</p>
          <ul style="text-align: left;">
            <li>Network connectivity issues</li>
            <li>Content blockers or restrictive firewall settings</li>
            <li>CDN unavailability</li>
          </ul>
          <p>Check your browser console (F12) for more details.</p>
          <p>Try reloading the page or using a different browser.</p>
          <button id="dismissError" style="margin-top: 10px; background-color: #721c24; color: white; border: none; padding: 8px 15px; cursor: pointer;">Dismiss</button>
        `;
        
        document.body.appendChild(error);
        
        // Add dismiss button handler
        document.getElementById('dismissError').addEventListener('click', function() {
          document.body.removeChild(error);
        });
        
        return false;
      }
      
      return true;
    }
    
    // Run on page load
    window.addEventListener('load', function() {
      // Check browser compatibility
      checkBrowserCompatibility();
      
      // Check if Blockly loaded successfully
      const blocklyLoaded = checkBlocklyLoaded();
      
      if (blocklyLoaded) {
        console.log('Blockly loaded successfully');
      }
    });
    
    // Initialize test button
    document.getElementById('testButton').addEventListener('click', async function() {
      // Check again if Blockly is loaded before running tests
      if (!checkBlocklyLoaded()) {
        return;
      }
      
      this.disabled = true;
      this.textContent = 'Running Tests...';
      
      try {
        const results = await runBlocklyIntegrationTests();
        displayTestResults(results);
      } catch (error) {
        console.error('Error running tests:', error);
        alert('Error running tests: ' + error.message);
      } finally {
        this.disabled = false;
        this.textContent = 'Run Tests';
      }
    });
  </script>
</body>
</html>