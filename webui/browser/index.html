<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Universal Intelligence Dev UI</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
      height: 100%;
      background-color: #f8f9fa;
      color: #333;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .header {
      background-color: #212529;
      color: white;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .agent-selector {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ced4da;
      background-color: white;
      margin-left: 8px;
      color: #333;
    }
    
    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #fff;
      font-size: 14px;
    }
    
    .toggle-switch input[type="checkbox"] {
      appearance: none;
      width: 40px;
      height: 20px;
      background-color: #555;
      border-radius: 20px;
      position: relative;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .toggle-switch input[type="checkbox"]:checked {
      background-color: #0d6efd;
    }
    
    .toggle-switch input[type="checkbox"]::before {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      background-color: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    
    .toggle-switch input[type="checkbox"]:checked::before {
      transform: translateX(20px);
    }
    
    .session-id {
      font-size: 14px;
      color: #aaa;
      margin-right: 16px;
    }
    
    .content {
      display: flex;
      height: calc(100vh - 56px);
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px;
      overflow: hidden;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-bottom: 16px;
    }
    
    .chat-input-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .input-tools {
      display: flex;
      gap: 8px;
    }
    
    .input-tool-button {
      background-color: #f0f0f0;
      border: none;
      border-radius: 4px;
      padding: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .input-tool-button:hover {
      background-color: #e0e0e0;
    }
    
    .chat-input {
      display: flex;
      gap: 12px;
    }
    
    .chat-input textarea {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ced4da;
      resize: none;
      min-height: 60px;
      font-family: 'Open Sans', sans-serif;
    }
    
    .chat-input button {
      padding: 0 24px;
      background-color: #0d6efd;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .chat-input button:hover {
      background-color: #0b5ed7;
    }
    
    .chat-input button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    .debug-panel {
      width: 450px;
      background-color: white;
      border-left: 1px solid #dee2e6;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .debug-tabs {
      display: flex;
      border-bottom: 1px solid #dee2e6;
    }
    
    .debug-tab {
      padding: 12px 16px;
      cursor: pointer;
      position: relative;
      font-size: 14px;
      color: #495057;
    }
    
    .debug-tab.active {
      color: #0d6efd;
      font-weight: 600;
    }
    
    .debug-tab.active::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #0d6efd;
    }
    
    .debug-event-nav {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .event-count {
      flex: 1;
      font-size: 14px;
      color: #6c757d;
    }
    
    .event-nav-buttons {
      display: flex;
      gap: 8px;
    }
    
    .event-nav-button {
      background: none;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .event-nav-button:hover {
      background-color: #f8f9fa;
    }
    
    .event-nav-button:disabled {
      color: #ced4da;
      cursor: not-allowed;
    }
    
    .debug-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .debug-content-panel {
      display: none;
    }
    
    .debug-content-panel.active {
      display: block;
    }
    
    .debug-title {
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .debug-actions {
      display: flex;
      gap: 8px;
    }
    
    .debug-action-button {
      background: none;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .debug-action-button:hover {
      background-color: #f8f9fa;
    }
    
    .debug-section {
      margin-bottom: 16px;
    }
    
    .debug-section h3 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #495057;
    }
    
    .debug-json {
      background-color: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .json-collapsible {
      cursor: pointer;
      user-select: none;
    }
    
    .json-collapsed::after {
      content: " ...";
      color: #999;
    }
    
    .json-key {
      color: #0d6efd;
    }
    
    .json-string {
      color: #28a745;
    }
    
    .json-number {
      color: #fd7e14;
    }
    
    .json-boolean {
      color: #dc3545;
    }
    
    .json-null {
      color: #6c757d;
    }
    
    .function-call {
      margin-top: 8px;
      padding: 12px;
      background-color: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid #0d6efd;
    }
    
    .function-call-name {
      font-weight: 600;
      color: #0d6efd;
      margin-bottom: 4px;
    }
    
    .function-call-args {
      font-family: monospace;
      font-size: 12px;
    }
    
    .message {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      position: relative;
    }
    
    .message-tools {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .message:hover .message-tools {
      opacity: 1;
    }
    
    .message-tool-button {
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px solid #dee2e6;
      border-radius: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
    }
    
    .message-tool-button:hover {
      background-color: white;
    }
    
    .user-message {
      background-color: #e9ecef;
      margin-left: 40px;
    }
    
    .agent-message {
      background-color: #f1f8ff;
      margin-right: 40px;
    }
    
    .message-header {
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
    }
    
    .message-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #0d6efd;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-right: 8px;
    }
    
    .user-message .message-avatar {
      background-color: #6c757d;
    }
    
    .hidden {
      display: none;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #0d6efd;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    .thinking-section {
      font-size: 14px;
      color: #6c757d;
      margin-top: 8px;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid #6c757d;
    }
    
    .thinking-toggle {
      font-size: 12px;
      color: #6c757d;
      cursor: pointer;
      margin-top: 8px;
      display: inline-block;
    }
    
    /* Attach file and image viewer styles */
    .file-dropzone {
      border: 2px dashed #ced4da;
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      margin-bottom: 16px;
      background-color: #f8f9fa;
      cursor: pointer;
    }
    
    .file-dropzone.drag-over {
      border-color: #0d6efd;
      background-color: rgba(13, 110, 253, 0.05);
    }
    
    .file-dropzone-text {
      color: #6c757d;
      font-size: 14px;
    }
    
    .file-preview {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-top: 16px;
    }
    
    .file-preview-item {
      position: relative;
      border-radius: 4px;
      overflow: hidden;
      width: 100px;
      height: 100px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .file-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .file-preview-item-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      color: #dc3545;
    }
    
    .file-preview-item-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 4px;
      font-size: 10px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    
    .image-viewer {
      display: flex;
      flex-direction: column;
      max-width: 100%;
      margin-bottom: 8px;
    }
    
    .image-viewer img {
      max-width: 100%;
      border-radius: 4px;
    }
    
    .image-viewer-caption {
      font-size: 12px;
      color: #6c757d;
      margin-top: 4px;
    }
    
    /* Function call visualization */
    .function-call-highlight {
      position: relative;
      font-family: monospace;
      background-color: rgba(13, 110, 253, 0.05);
      padding: 12px;
      border-radius: 4px;
      margin: 8px 0;
      border-left: 3px solid #0d6efd;
    }
    
    .function-call-title {
      font-size: 12px;
      font-weight: 600;
      color: #0d6efd;
      margin-bottom: 8px;
    }
    
    .function-call-params {
      font-size: 12px;
    }
    
    .function-call-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      display: inline-block;
      margin-left: 8px;
    }
    
    .status-pending {
      background-color: #ffc107;
      color: #212529;
    }
    
    .status-success {
      background-color: #28a745;
      color: white;
    }
    
    .status-error {
      background-color: #dc3545;
      color: white;
    }
    
    .action-button {
      padding: 8px 16px;
      background-color: white;
      border: 1px solid #ced4da;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-right: 8px;
    }
    
    .action-button:hover {
      background-color: #f8f9fa;
    }
    
    .action-button-primary {
      background-color: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    .action-button-primary:hover {
      background-color: #0b5ed7;
    }
    
    .action-button-destructive {
      background-color: #dc3545;
      color: white;
      border-color: #dc3545;
    }
    
    .action-button-destructive:hover {
      background-color: #bb2d3b;
    }
    
    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Improved code block highlighting */
    pre {
      background-color: #282c34;
      color: #abb2bf;
      padding: 16px;
      border-radius: 4px;
      overflow-x: auto;
      position: relative;
      margin: 8px 0;
    }
    
    pre code {
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .code-copy-button {
      position: absolute;
      top: 8px;
      right: 8px;
      background-color: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 4px;
      color: #abb2bf;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .code-copy-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .content {
        flex-direction: column;
      }
      
      .debug-panel {
        width: 100%;
        border-left: none;
        border-top: 1px solid #dee2e6;
        height: 30%;
      }
      
      .chat-container {
        height: 70%;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <div class="header-title">Universal Intelligence Dev UI</div>
      <div class="header-controls">
        <span id="session-id" class="session-id"></span>
        <div class="toggle-switch">
          <span>Token Streaming</span>
          <input type="checkbox" id="stream-toggle" checked>
        </div>
        <div>
          <label for="agent-select">Agent:</label>
          <select id="agent-select" class="agent-selector">
            <option value="">Select an agent</option>
          </select>
        </div>
        <button id="new-session-btn" class="action-button">
          <span>New Session</span>
        </button>
      </div>
    </div>
    
    <div class="content">
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="message agent-message">
            <div class="message-header">
              <div class="message-avatar">A</div>
              <span>Agent</span>
            </div>
            <div>Welcome to Universal Intelligence! Select an agent to start chatting.</div>
          </div>
        </div>
        
        <div class="chat-input-container">
          <div class="input-tools">
            <button class="input-tool-button" id="upload-file-btn" title="Upload Files">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 15V18C4 19.1046 4.89543 20 6 20H18C19.1046 20 20 19.1046 20 18V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 4V16M12 4L16 8M12 4L8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <input type="file" id="file-input" multiple style="display: none">
          </div>
          
          <div id="file-previews" class="file-preview hidden"></div>
          
          <div class="chat-input">
            <textarea id="user-input" placeholder="Type your message..." disabled></textarea>
            <button id="send-button" disabled>Send</button>
          </div>
        </div>
      </div>
      
      <div class="debug-panel">
        <div class="debug-tabs">
          <div class="debug-tab active" data-tab="event">Event</div>
          <div class="debug-tab" data-tab="request">Request</div>
          <div class="debug-tab" data-tab="response">Response</div>
        </div>
        
        <div class="debug-event-nav">
          <div class="event-count" id="event-count">Event 0 of 0</div>
          <div class="event-nav-buttons">
            <button class="event-nav-button" id="prev-event-btn" disabled>&lt;</button>
            <button class="event-nav-button" id="next-event-btn" disabled>&gt;</button>
          </div>
        </div>
        
        <div class="debug-content">
          <div class="debug-content-panel active" id="event-panel">
            <div class="debug-title">
              Event Details
              <div class="debug-actions">
                <button class="debug-action-button" id="copy-event-btn">Copy</button>
              </div>
            </div>
            <div class="debug-json" id="event-json">No events yet</div>
          </div>
          
          <div class="debug-content-panel" id="request-panel">
            <div class="debug-title">
              Request
              <div class="debug-actions">
                <button class="debug-action-button" id="copy-request-btn">Copy</button>
              </div>
            </div>
            <div class="debug-json" id="request-json">No request data</div>
          </div>
          
          <div class="debug-content-panel" id="response-panel">
            <div class="debug-title">
              Response
              <div class="debug-actions">
                <button class="debug-action-button" id="copy-response-btn">Copy</button>
              </div>
            </div>
            <div class="debug-json" id="response-json">No response data</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // State
    let selectedAgent = '';
    let currentSession = null;
    let messages = [];
    let uploadedFiles = [];
    let allEvents = [];
    let currentEventIndex = -1;
    
    // DOM Elements
    const agentSelect = document.getElementById('agent-select');
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const uploadFileBtn = document.getElementById('upload-file-btn');
    const fileInput = document.getElementById('file-input');
    const filePreviews = document.getElementById('file-previews');
    const sessionIdElem = document.getElementById('session-id');
    const streamToggle = document.getElementById('stream-toggle');
    const newSessionBtn = document.getElementById('new-session-btn');
    const eventJson = document.getElementById('event-json');
    const requestJson = document.getElementById('request-json');
    const responseJson = document.getElementById('response-json');
    const prevEventBtn = document.getElementById('prev-event-btn');
    const nextEventBtn = document.getElementById('next-event-btn');
    const eventCount = document.getElementById('event-count');
    const copyEventBtn = document.getElementById('copy-event-btn');
    const copyRequestBtn = document.getElementById('copy-request-btn');
    const copyResponseBtn = document.getElementById('copy-response-btn');
    const debugTabs = document.querySelectorAll('.debug-tab');
    
    // Functions
    async function fetchAgents() {
      try {
        console.log("Fetching agents...");
        
        // Try multiple potential endpoints - the original code used '/list-apps', but your API might use a different endpoint
        const endpoints = [
          '/list-apps',
          '/agents',
          '/apps'
        ];
        
        let agents = [];
        let foundEndpoint = false;
        
        for (const endpoint of endpoints) {
          try {
            console.log(`Trying endpoint: ${endpoint}`);
            const response = await fetch(endpoint);
            if (response.ok) {
              agents = await response.json();
              console.log(`Success with endpoint ${endpoint}:`, agents);
              foundEndpoint = true;
              break;
            }
          } catch (e) {
            console.log(`Endpoint ${endpoint} failed:`, e);
          }
        }
        
        if (!foundEndpoint) {
          // If all endpoints fail, simulate at least one agent for testing
          console.log("All endpoints failed, adding test agent");
          agents = ["test"];
        }
        
        // Populate the agent selector
        agentSelect.innerHTML = '<option value="">Select an agent</option>';
        
        agents.forEach(agent => {
          const option = document.createElement('option');
          option.value = agent;
          option.textContent = agent;
          agentSelect.appendChild(option);
        });
        
        // If there's only one agent, auto-select it
        if (agents.length === 1) {
          agentSelect.value = agents[0];
          selectedAgent = agents[0];
          createSession(selectedAgent);
        }
      } catch (error) {
        console.error('Error loading agents:', error);
        showNotification('Failed to load agents. Added test agent as fallback.', 'error');
        
        // Add test agent as fallback
        const option = document.createElement('option');
        option.value = "test";
        option.textContent = "test";
        agentSelect.appendChild(option);
      }
    }
    
    async function createSession(agentName) {
      try {
        // Clear existing messages and state
        chatMessages.innerHTML = '';
        uploadedFiles = [];
        allEvents = [];
        currentEventIndex = -1;
        filePreviews.innerHTML = '';
        filePreviews.classList.add('hidden');
        
        // Show loading
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'message agent-message';
        loadingMessage.innerHTML = `
          <div class="message-header">
            <div class="message-avatar">A</div>
            <span>Agent</span>
          </div>
          <div><span class="loading-spinner"></span>Creating session...</div>
        `;
        chatMessages.appendChild(loadingMessage);
        
        // Try to create a session - try multiple endpoint patterns
        let response;
        let sessionEndpoints = [
          `/apps/${agentName}/users/test-user/sessions`,
          `/agents/${agentName}/sessions`,
          `/session/${agentName}`
        ];
        
        let success = false;
        for (const endpoint of sessionEndpoints) {
          try {
            console.log(`Trying to create session with endpoint: ${endpoint}`);
            response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({}),
            });
            
            if (response.ok) {
              console.log(`Successfully created session with endpoint: ${endpoint}`);
              success = true;
              break;
            }
          } catch (e) {
            console.log(`Session creation failed with endpoint ${endpoint}:`, e);
          }
        }
        
        if (!success) {
          // If all endpoints fail, create a mock session for testing
          console.log("All session creation endpoints failed, creating mock session");
          // Simulate a successful response
          response = {
            ok: true,
            json: () => Promise.resolve({
              id: "test-session-" + Math.random().toString(36).substring(2, 10),
              user_id: "test-user",
              app_name: agentName,
              created_at: new Date().toISOString()
            })
          };
        }
        
        if (!response.ok) throw new Error('Failed to create session');
        
        // Store session data
        currentSession = await response.json();
        
        // Create 'session created' event
        const sessionEvent = {
          type: 'session_created',
          timestamp: new Date().toISOString(),
          session: currentSession
        };
        addEvent(sessionEvent);
        
        // Update UI
        sessionIdElem.textContent = `Session: ${currentSession.id.slice(0, 8)}`;
        userInput.disabled = false;
        sendButton.disabled = false;
        
        // Remove loading message
        chatMessages.removeChild(loadingMessage);
        
        // Add welcome message
        addAgentMessage('Hello! How can I help you today?');
        
      } catch (error) {
        console.error('Error creating session:', error);
        showNotification('Failed to create session', 'error');
        
        // Remove loading message if exists
        const loadingMessage = chatMessages.querySelector('.message:last-child');
        if (loadingMessage && loadingMessage.textContent.includes('Creating session')) {
          chatMessages.removeChild(loadingMessage);
        }
        
        // Add error message
        const errorMessage = document.createElement('div');
        errorMessage.className = 'message agent-message';
        errorMessage.innerHTML = `
          <div class="message-header">
            <div class="message-avatar">A</div>
            <span>Agent</span>
          </div>
          <div>Error: Failed to create session. Please try again or select a different agent.</div>
        `;
        chatMessages.appendChild(errorMessage);
      }
    }
    
    async function sendMessage(text, files = []) {
      if (!currentSession) return;
      
      // Add user message to UI
      addUserMessage(text, files);
      
      // Disable input while processing
      userInput.disabled = true;
      sendButton.disabled = true;
      
      // Prepare files data if any
      const fileData = [];
      for (const file of files) {
        try {
          const reader = new FileReader();
          const fileDataPromise = new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
          });
          
          reader.readAsDataURL(file);
          const dataUrl = await fileDataPromise;
          
          fileData.push({
            name: file.name,
            content_type: file.type,
            data: dataUrl.split(',')[1] // Remove data URL prefix
          });
        } catch (e) {
          console.error('Error reading file:', e);
          showNotification(`Error reading file: ${file.name}`, 'error');
        }
      }
      
      try {
        // Create a temporary loading message
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'message agent-message';
        loadingMessage.innerHTML = `
          <div class="message-header">
            <div class="message-avatar">A</div>
            <span>Agent</span>
          </div>
          <div><span class="loading-spinner"></span>Thinking...</div>
        `;
        chatMessages.appendChild(loadingMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Create user message event
        const userEvent = {
          type: 'user_message',
          timestamp: new Date().toISOString(),
          request: {
            text,
            files: files.map(f => f.name)
          }
        };
        addEvent(userEvent);
        
        // Determine if streaming should be used
        const isStreaming = streamToggle.checked;
        
        // Prepare request data
        const requestData = {
          app_name: selectedAgent,
          user_id: currentSession.user_id,
          session_id: currentSession.id,
          new_message: {
            role: 'user',
            parts: [{ text }]
          },
          streaming: isStreaming,
          files: fileData
        };
        
        // Try different API endpoints for sending messages
        let messageEndpoints = isStreaming ? 
          ['/run_sse', '/stream', `/apps/${selectedAgent}/users/test-user/sessions/${currentSession.id}/stream`] :
          ['/run', '/message', `/apps/${selectedAgent}/users/test-user/sessions/${currentSession.id}/message`];
        
        let response;
        let success = false;
        
        for (const endpoint of messageEndpoints) {
          try {
            console.log(`Trying to send message with endpoint: ${endpoint}`);
            response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestData)
            });
            
            if (response.ok) {
              console.log(`Successfully sent message with endpoint: ${endpoint}`);
              success = true;
              break;
            }
          } catch (e) {
            console.log(`Message sending failed with endpoint ${endpoint}:`, e);
          }
        }
        
        if (!success) {
          throw new Error('Failed to send message - all endpoints failed');
        }
        
        // Remove loading message
        chatMessages.removeChild(loadingMessage);
        
        // Send request and handle response
        if (isStreaming) {
          // Handle streaming response
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          
          // Create a new agent message for streaming response
          const agentMessageElem = document.createElement('div');
          agentMessageElem.className = 'message agent-message';
          agentMessageElem.innerHTML = `
            <div class="message-header">
              <div class="message-avatar">A</div>
              <span>Agent</span>
            </div>
            <div class="agent-content"></div>
            <div class="message-tools">
              <button class="message-tool-button" title="Copy" onclick="copyMessageText(this)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="9" y="9" width="11" height="11" rx="2" stroke="currentColor" stroke-width="2"/>
                  <path d="M5 15H4C2.89543 15 2 14.1046 2 13V5C2 3.89543 2.89543 3 4 3H12C13.1046 3 14 3.89543 14 5V6" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
          `;
          chatMessages.appendChild(agentMessageElem);
          const agentContent = agentMessageElem.querySelector('.agent-content');
          
          // Create container for function calls if needed
          const functionCallsContainer = document.createElement('div');
          functionCallsContainer.className = 'function-calls-container';
          
          // Track extracted information from response
          let textContent = '';
          let functionCalls = [];
          
          try {
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              // Decode and process the chunk
              buffer += decoder.decode(value, { stream: true });
              
              // Process any complete SSE events in the buffer
              const events = buffer.split('\n\n');
              buffer = events.pop() || ''; // Keep the last incomplete event in the buffer
              
              for (const eventText of events) {
                if (!eventText.trim() || !eventText.startsWith('data:')) continue;
                
                const eventData = eventText.replace('data: ', '');
                try {
                  const event = JSON.parse(eventData);
                  
                  // Add to our events list
                  addEvent(event);
                  
                  // Extract and display text content
                  if (event.content && event.content.parts) {
                    // Process text content
                    const textParts = event.content.parts.filter(part => part.text);
                    if (textParts.length > 0) {
                      textContent = textParts.map(part => part.text).join('');
                      
                      // Split thinking and response if detected
                      const processedText = processBotResponse(textContent);
                      if (processedText.hasThinking) {
                        // Display response and add thinking toggle
                        agentContent.innerHTML = `
                          <div>${formatMessageContent(processedText.response)}</div>
                          <div class="thinking-toggle" onclick="toggleThinking(this)">Show thinking process</div>
                          <div class="thinking-section hidden">${processedText.thinking}</div>
                        `;
                      } else {
                        agentContent.innerHTML = formatMessageContent(textContent);
                      }
                    }
                    
                    // Extract function calls if any
                    const functionCallParts = event.content.parts.filter(part => part.function_call);
                    if (functionCallParts.length > 0) {
                      functionCalls = functionCallParts.map(part => part.function_call);
                      
                      // Clear previous function calls
                      functionCallsContainer.innerHTML = '';
                      
                      // Add each function call
                      functionCalls.forEach(functionCall => {
                        const functionCallElem = document.createElement('div');
                        functionCallElem.className = 'function-call-highlight';
                        functionCallElem.innerHTML = `
                          <div class="function-call-title">${functionCall.name}<span class="function-call-status status-success">Called</span></div>
                          <div class="function-call-params">${JSON.stringify(functionCall.args || {}, null, 2)}</div>
                        `;
                        functionCallsContainer.appendChild(functionCallElem);
                      });
                      
                      // Add function calls to message
                      if (functionCallsContainer.children.length > 0) {
                        agentContent.appendChild(functionCallsContainer);
                      }
                    }
                  }
                } catch (e) {
                  console.error('Error parsing event:', e, eventData);
                }
              }
              
              // Auto-scroll
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          } catch (streamError) {
            console.error('Error in stream processing:', streamError);
            // Add error message inside the agent response
            agentContent.innerHTML += `<div class="error-message">Error: ${streamError.message}</div>`;
          }
          
          // Add response event
          const responseEvent = {
            type: 'agent_response',
            timestamp: new Date().toISOString(),
            response: {
              text: textContent || "",
              functionCalls: functionCalls || []
            }
          };
          addEvent(responseEvent);
          
        } else {
          // Non-streaming case - response should already be obtained from the loop above
          // Process response
          const events = await response.json();
          const lastEvent = events[events.length - 1];
          
          // Add events to our list
          events.forEach(event => addEvent(event));
          
          // Extract text and function calls
          let text = '';
          let functionCalls = [];
          
          if (lastEvent.content && lastEvent.content.parts) {
            // Process text content
            const textParts = lastEvent.content.parts.filter(part => part.text);
            if (textParts.length > 0) {
              text = textParts.map(part => part.text).join('');
            }
            
            // Extract function calls if any
            const functionCallParts = lastEvent.content.parts.filter(part => part.function_call);
            if (functionCallParts.length > 0) {
              functionCalls = functionCallParts.map(part => part.function_call);
            }
          }
          
          // Display response
          const processedText = processBotResponse(text);
          if (processedText.hasThinking) {
            addAgentMessage(`
              <div>${formatMessageContent(processedText.response)}</div>
              <div class="thinking-toggle" onclick="toggleThinking(this)">Show thinking process</div>
              <div class="thinking-section hidden">${processedText.thinking}</div>
            `);
          } else {
            // Add regular message
            addAgentMessage(formatMessageContent(text));
            
            // Add function calls if any
            if (functionCalls.length > 0) {
              const functionCallsElem = document.createElement('div');
              functionCallsElem.className = 'function-calls-container';
              
              functionCalls.forEach(functionCall => {
                const functionCallElem = document.createElement('div');
                functionCallElem.className = 'function-call-highlight';
                functionCallElem.innerHTML = `
                  <div class="function-call-title">${functionCall.name}<span class="function-call-status status-success">Called</span></div>
                  <div class="function-call-params">${JSON.stringify(functionCall.args || {}, null, 2)}</div>
                `;
                functionCallsElem.appendChild(functionCallElem);
              });
              
              // Find last agent message and add function calls
              const lastAgentMessage = document.querySelector('.agent-message:last-child');
              lastAgentMessage.appendChild(functionCallsElem);
            }
          }
        }
        
        // Clear uploaded files after sending
        clearUploadedFiles();
        
      } catch (error) {
        console.error('Error sending message:', error);
        
        // Remove loading message if exists
        const loadingMessage = chatMessages.querySelector('.message:last-child');
        if (loadingMessage && loadingMessage.textContent.includes('Thinking')) {
          chatMessages.removeChild(loadingMessage);
        }
        
        // Add error message
        addAgentMessage('Sorry, there was an error processing your message: ' + error.message);
        
        // Create error event
        const errorEvent = {
          type: 'error',
          timestamp: new Date().toISOString(),
          error: error.message
        };
        addEvent(errorEvent);
        
      } finally {
        // Re-enable input
        userInput.disabled = false;
        sendButton.disabled = false;
        userInput.focus();
      }
    }
    
    function processBotResponse(text) {
      // Look for thinking pattern in the response
      const thinkingPattern = /^The original query was .+, and there were no dependency calls made in response to this query\. Therefore, the direct response to the query is:\s*(.+)$/s;
      const match = text.match(thinkingPattern);
      
      if (match) {
        return {
          hasThinking: true,
          thinking: text.substring(0, text.indexOf('Therefore, the direct response to the query is:')),
          response: match[1].trim()
        };
      } else {
        return {
          hasThinking: false,
          response: text
        };
      }
    }
    
    function formatMessageContent(text) {
      // Check for code blocks and highlight them
      let formattedText = text.replace(/```([a-zA-Z]*)\n([\s\S]*?)```/g, (match, language, code) => {
        return `<pre><code class="language-${language}">${code}</code><button class="code-copy-button" onclick="copyCodeToClipboard(this)">Copy</button></pre>`;
      });
      
      // Handle inline code
      formattedText = formattedText.replace(/`([^`]+)`/g, '<code>$1</code>');
      
      // Handle function calls/tool use
      formattedText = formattedText.replace(/get_current_time/g, '<span class="function-call-inline">get_current_time</span>');
      formattedText = formattedText.replace(/get_weather/g, '<span class="function-call-inline">get_weather</span>');
      
      return formattedText;
    }
    
    function copyCodeToClipboard(button) {
      const codeBlock = button.previousElementSibling;
      const code = codeBlock.textContent;
      
      navigator.clipboard.writeText(code)
        .then(() => {
          button.textContent = 'Copied!';
          setTimeout(() => { button.textContent = 'Copy'; }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy code:', err);
          button.textContent = 'Error';
          setTimeout(() => { button.textContent = 'Copy'; }, 2000);
        });
    }
    
    // Function to toggle thinking section visibility
    function toggleThinking(element) {
      const thinkingSection = element.nextElementSibling;
      const isHidden = thinkingSection.classList.contains('hidden');
      
      if (isHidden) {
        thinkingSection.classList.remove('hidden');
        element.textContent = 'Hide thinking process';
      } else {
        thinkingSection.classList.add('hidden');
        element.textContent = 'Show thinking process';
      }
      
      // Auto-scroll when showing thinking
      if (isHidden) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
    
    // Add this to the global scope for event handlers
    window.toggleThinking = toggleThinking;
    window.copyCodeToClipboard = copyCodeToClipboard;
    
    function addUserMessage(text, files = []) {
      const messageElem = document.createElement('div');
      messageElem.className = 'message user-message';
      
      let messageContent = `
        <div class="message-header">
          <div class="message-avatar">Y</div>
          <span>You</span>
        </div>
        <div>${text}</div>
      `;
      
      // Add image previews if any
      if (files.length > 0) {
        let filePreviewsHTML = '<div class="file-preview">';
        
        files.forEach(file => {
          if (file.type.startsWith('image/')) {
            filePreviewsHTML += `
              <div class="image-viewer">
                <img src="${URL.createObjectURL(file)}" alt="${file.name}" />
                <div class="image-viewer-caption">${file.name}</div>
              </div>
            `;
          } else {
            filePreviewsHTML += `
              <div class="file-attachment">
                <div class="file-attachment-icon">ðŸ“„</div>
                <div class="file-attachment-name">${file.name}</div>
              </div>
            `;
          }
        });
        
        filePreviewsHTML += '</div>';
        messageContent += filePreviewsHTML;
      }
      
      messageElem.innerHTML = messageContent;
      chatMessages.appendChild(messageElem);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function addAgentMessage(text) {
      const messageElem = document.createElement('div');
      messageElem.className = 'message agent-message';
      messageElem.innerHTML = `
        <div class="message-header">
          <div class="message-avatar">A</div>
          <span>Agent</span>
        </div>
        <div>${formatMessageContent(text)}</div>
        <div class="message-tools">
          <button class="message-tool-button" title="Copy" onclick="copyMessageText(this)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="9" y="9" width="11" height="11" rx="2" stroke="currentColor" stroke-width="2"/>
              <path d="M5 15H4C2.89543 15 2 14.1046 2 13V5C2 3.89543 2.89543 3 4 3H12C13.1046 3 14 3.89543 14 5V6" stroke="currentColor" stroke-width="2"/>
            </svg>
          </button>
        </div>
      `;
      chatMessages.appendChild(messageElem);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function copyMessageText(button) {
      const messageContent = button.parentElement.previousElementSibling;
      const text = messageContent.innerText;
      
      navigator.clipboard.writeText(text)
        .then(() => {
          showNotification('Copied to clipboard', 'success');
        })
        .catch(err => {
          console.error('Failed to copy text:', err);
          showNotification('Failed to copy', 'error');
        });
    }
    
    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      
      // Add to document
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.classList.add('notification-visible');
      }, 10);
      
      // Remove after delay
      setTimeout(() => {
        notification.classList.remove('notification-visible');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }
    
    // Event handling and debug panel management
    function addEvent(event) {
      // Add timestamp if not present
      if (!event.timestamp) {
        event.timestamp = new Date().toISOString();
      }
      
      // Add to events list
      allEvents.push(event);
      currentEventIndex = allEvents.length - 1;
      
      // Update UI
      updateEventDisplay();
      updateEventCountDisplay();
    }
    
    function updateEventDisplay() {
      if (currentEventIndex < 0 || currentEventIndex >= allEvents.length) {
        clearDebugPanels();
        return;
      }
      
      const event = allEvents[currentEventIndex];
      eventJson.textContent = JSON.stringify(event, null, 2);
      
      // Update request/response panels based on event type
      if (event.type === 'user_message' || event.type === 'session_created') {
        requestJson.textContent = JSON.stringify(event.request || event.session || {}, null, 2);
        responseJson.textContent = 'No response data';
      } else if (event.type === 'agent_response') {
        responseJson.textContent = JSON.stringify(event.response || {}, null, 2);
      } else if (event.type === 'error') {
        responseJson.textContent = JSON.stringify({ error: event.error }, null, 2);
      }
    }
    
    function updateEventCountDisplay() {
      if (allEvents.length === 0) {
        eventCount.textContent = 'Event 0 of 0';
        prevEventBtn.disabled = true;
        nextEventBtn.disabled = true;
      } else {
        eventCount.textContent = `Event ${currentEventIndex + 1} of ${allEvents.length}`;
        prevEventBtn.disabled = currentEventIndex <= 0;
        nextEventBtn.disabled = currentEventIndex >= allEvents.length - 1;
      }
    }
    
    function clearDebugPanels() {
      eventJson.textContent = 'No events yet';
      requestJson.textContent = 'No request data';
      responseJson.textContent = 'No response data';
    }
    
    // File handling functions
    function handleFileUpload(files) {
      for (const file of files) {
        // Check file type and size
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
          showNotification(`File ${file.name} exceeds 10MB limit`, 'error');
          continue;
        }
        
        uploadedFiles.push(file);
        
        // Show preview
        const previewItem = document.createElement('div');
        previewItem.className = 'file-preview-item';
        
        if (file.type.startsWith('image/')) {
          previewItem.innerHTML = `
            <img src="${URL.createObjectURL(file)}" alt="${file.name}" />
            <div class="file-preview-item-info">${file.name}</div>
            <div class="file-preview-item-remove" data-file-index="${uploadedFiles.length - 1}">Ã—</div>
          `;
        } else {
          previewItem.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 24px;">ðŸ“„</div>
            <div class="file-preview-item-info">${file.name}</div>
            <div class="file-preview-item-remove" data-file-index="${uploadedFiles.length - 1}">Ã—</div>
          `;
        }
        
        filePreviews.appendChild(previewItem);
      }
      
      filePreviews.classList.remove('hidden');
      
      // Set up remove buttons
      const removeButtons = document.querySelectorAll('.file-preview-item-remove');
      removeButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          const fileIndex = parseInt(e.target.getAttribute('data-file-index'));
          uploadedFiles = uploadedFiles.filter((_, index) => index !== fileIndex);
          e.target.parentElement.remove();
          
          if (uploadedFiles.length === 0) {
            filePreviews.classList.add('hidden');
          }
        });
      });
    }
    
    function clearUploadedFiles() {
      uploadedFiles = [];
      filePreviews.innerHTML = '';
      filePreviews.classList.add('hidden');
    }
    
    // Event Listeners
    agentSelect.addEventListener('change', () => {
      selectedAgent = agentSelect.value;
      if (selectedAgent) {
        createSession(selectedAgent);
      } else {
        userInput.disabled = true;
        sendButton.disabled = true;
      }
    });
    
    sendButton.addEventListener('click', () => {
      const text = userInput.value.trim();
      if (text) {
        sendMessage(text, uploadedFiles);
        userInput.value = '';
      }
    });
    
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendButton.click();
      }
    });
    
    // Upload file button
    uploadFileBtn.addEventListener('click', () => {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileUpload(e.target.files);
      }
    });
    
    // New session button
    newSessionBtn.addEventListener('click', () => {
      if (selectedAgent) {
        createSession(selectedAgent);
      } else {
        showNotification('Please select an agent first', 'error');
      }
    });
    
    // Debug panel tab navigation
    debugTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Update active tab
        debugTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show corresponding panel
        const panelId = tab.getAttribute('data-tab');
        document.querySelectorAll('.debug-content-panel').forEach(panel => {
          panel.classList.remove('active');
        });
        document.getElementById(`${panelId}-panel`).classList.add('active');
      });
    });
    
    // Event navigation
    prevEventBtn.addEventListener('click', () => {
      if (currentEventIndex > 0) {
        currentEventIndex--;
        updateEventDisplay();
        updateEventCountDisplay();
      }
    });
    
    nextEventBtn.addEventListener('click', () => {
      if (currentEventIndex < allEvents.length - 1) {
        currentEventIndex++;
        updateEventDisplay();
        updateEventCountDisplay();
      }
    });
    
    // Copy buttons
    copyEventBtn.addEventListener('click', () => {
      copyToClipboard(eventJson.textContent);
    });
    
    copyRequestBtn.addEventListener('click', () => {
      copyToClipboard(requestJson.textContent);
    });
    
    copyResponseBtn.addEventListener('click', () => {
      copyToClipboard(responseJson.textContent);
    });
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => {
          showNotification('Copied to clipboard', 'success');
        })
        .catch(err => {
          console.error('Failed to copy:', err);
          showNotification('Failed to copy', 'error');
        });
    }
    
    // Add notification styles dynamically
    const notificationStyles = document.createElement('style');
    notificationStyles.textContent = `
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 4px;
        color: white;
        font-size: 14px;
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s, transform 0.3s;
        z-index: 1000;
      }
      
      .notification-visible {
        opacity: 1;
        transform: translateY(0);
      }
      
      .notification-info {
        background-color: #0d6efd;
      }
      
      .notification-success {
        background-color: #28a745;
      }
      
      .notification-error {
        background-color: #dc3545;
      }
    `;
    document.head.appendChild(notificationStyles);
    
    // Add debugging tools
    window.debugUI = {
      resetAgents: function() {
        agentSelect.innerHTML = '<option value="">Select an agent</option>';
        const option = document.createElement('option');
        option.value = "test";
        option.textContent = "test";
        agentSelect.appendChild(option);
        showNotification('Added test agent manually', 'info');
      },
      createTestSession: function() {
        selectedAgent = "test";
        agentSelect.value = "test";
        createSession("test");
        showNotification('Created test session manually', 'info');
      },
      showAllEndpoints: function() {
        console.log("Available debugging functions:");
        console.log("window.debugUI.resetAgents() - Add test agent to selector");
        console.log("window.debugUI.createTestSession() - Create a test session");
        console.log("window.debugUI.showAllEndpoints() - Show this help");
        return "Check console for debug commands";
      }
    };
    
    // Add keyboard shortcut for debug mode
    document.addEventListener('keydown', function(e) {
      // Ctrl+Shift+D to enter debug mode
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        console.log("Debug mode activated");
        window.debugUI.showAllEndpoints();
        showNotification('Debug mode activated - check console', 'info');
      }
    });
    
    // Initialize with extra logging
    console.log("Initializing Universal Intelligence Dev UI");
    console.log("Press Ctrl+Shift+D for debug mode");
    
    // Try to fetch agents, with fallback
    fetchAgents();
  </script>
</body>
</html>
